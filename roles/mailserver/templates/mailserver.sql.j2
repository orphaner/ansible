CREATE TABLE IF not exists `virtual_domains` (
       `id` int(11) NOT NULL auto_increment,
       `name` varchar(50) NOT NULL,
       PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE UNIQUE INDEX name_idx ON virtual_domains (name);

CREATE TABLE if not exists `virtual_users` (
       `id` int(11) NOT NULL auto_increment,
       `domain_id` int(11) NOT NULL,
       `password` varchar(32) NOT NULL,
       `email` varchar(100) NOT NULL,
       PRIMARY KEY (`id`),
       UNIQUE KEY `email` (`email`),
       FOREIGN KEY (domain_id) REFERENCES virtual_domains(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;



CREATE TABLE `virtual_aliases` (
       `id` int(11) NOT NULL auto_increment,
       `domain_id` int(11) NOT NULL,
       `source` varchar(100) NOT NULL,
       `destination` varchar(100) NOT NULL,
       PRIMARY KEY (`id`),
       FOREIGN KEY (domain_id) REFERENCES virtual_domains(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE INDEX source_idx ON virtual_aliases (source);


{% for virtual_domain in mail_virtual_domains %}
INSERT INTO virtual_domains (`name`)
VALUES (
       "{{ virtual_domain.name }}"
);
{% endfor %}

{% for virtual_user in mail_virtual_users %}
INSERT INTO virtual_users (`domain_id`, `password`, `email`)
VALUES (
       (select id from virtual_domains where name='{{ domain }}'),
       "{{ virtual_user.password_hash }}",
       "{{ virtual_user.account }}@{{ virtual_user.domain }}"
);
{% endfor %}

{% if mail_virtual_aliases is defined %}
{% for virtual_alias in mail_virtual_aliases %}
INSERT INTO virtual_aliases (`domain_id`, `source`, `destination`)
VALUES (
       (select id from virtual_domains where name='{{ domain }}'),
       "{{ virtual_alias.source }}",
       "{{virtual_alias.destination }}"
);
{% endfor %}
{% endif %}
